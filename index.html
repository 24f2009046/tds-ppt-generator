<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text to PowerPoint Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        textarea, input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 200px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-label {
            display: block;
            padding: 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        .file-label:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-label.dragover {
            border-color: #667eea;
            background: #e6fffa;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #e6fffa;
            border-radius: 6px;
            color: #2d3748;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            color: white;
        }

        .feature-card h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #667eea;
            margin-left: 5px;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .main-card {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Text to PowerPoint Generator</h1>
            <p>Transform your text into professional presentations with custom templates</p>
        </div>

        <div class="main-card">
            <form id="pptForm">
                <div class="form-section">
                    <h3><span class="section-number">1</span>Input Text</h3>
                    <div class="form-group">
                        <label for="inputText">
                            Paste your content (Markdown and plain text supported)
                            <span class="tooltip">?
                                <span class="tooltiptext">Supports markdown formatting, bullet points, headers, and long-form prose</span>
                            </span>
                        </label>
                        <textarea id="inputText" placeholder="Enter your text content here...

Example:
# Company Overview
We are revolutionizing the tech industry...

## Market Analysis  
- Current market size: $50B
- Growth rate: 25% annually
- Key competitors: Company A, B, C

## Our Solution
Our innovative approach solves three key problems:
1. Problem one and its solution
2. Problem two and its solution  
3. Problem three and its solution" required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3><span class="section-number">2</span>Presentation Guidance</h3>
                    <div class="form-group">
                        <label for="guidance">
                            Optional: Specify tone, structure, or use case
                            <span class="tooltip">?
                                <span class="tooltiptext">e.g., "investor pitch deck", "academic presentation", "sales demo", "technical overview"</span>
                            </span>
                        </label>
                        <input type="text" id="guidance" placeholder="e.g., 'turn into an investor pitch deck', 'academic conference presentation', 'sales demo'">
                    </div>
                </div>

                <div class="form-section">
                    <h3><span class="section-number">3</span>AI Configuration</h3>
                    <div class="form-group">
                        <label for="llmProvider">LLM Provider</label>
                        <select id="llmProvider" required>
                            <option value="">Select Provider</option>
                            <optgroup label="OpenAI">
                                <option value="openai-gpt4">OpenAI GPT-4</option>
                                <option value="openai-gpt4-turbo">OpenAI GPT-4 Turbo</option>
                                <option value="openai-gpt35-turbo">OpenAI GPT-3.5 Turbo</option>
                            </optgroup>
                            <optgroup label="Anthropic">
                                <option value="anthropic-claude35-sonnet">Claude 3.5 Sonnet</option>
                                <option value="anthropic-claude3-opus">Claude 3 Opus</option>
                                <option value="anthropic-claude3-sonnet">Claude 3 Sonnet</option>
                            </optgroup>
                            <optgroup label="Google">
                                <option value="gemini-15-pro">Gemini 1.5 Pro</option>
                                <option value="gemini-15-flash">Gemini 1.5 Flash</option>
                                <option value="gemini-10-pro">Gemini 1.0 Pro</option>
                            </optgroup>
                            <optgroup label="Azure OpenAI">
                                <option value="azure-openai">Azure OpenAI</option>
                            </optgroup>
                            <optgroup label="Local/Self-Hosted">
                                <option value="ollama">Ollama (Local)</option>
                            </optgroup>
                            <optgroup label="Cloud Providers">
                                <option value="together-ai">Together AI</option>
                                <option value="perplexity">Perplexity</option>
                                <option value="groq">Groq</option>
                                <option value="cohere">Cohere</option>
                                <option value="mistral-ai">Mistral AI</option>
                            </optgroup>
                            <optgroup label="Custom">
                                <option value="openai-compatible">OpenAI-Compatible API</option>
                                <option value="custom">Custom API</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Dynamic fields based on provider -->
                    <div id="providerConfig">
                        <!-- Standard API Key field -->
                        <div class="form-group" id="apiKeyGroup">
                            <label for="apiKey">
                                API Key (never stored)
                                <span class="tooltip">?
                                    <span class="tooltiptext">Your API key is used only for this session and never stored or logged</span>
                                </span>
                            </label>
                            <input type="password" id="apiKey" placeholder="Enter your API key" required>
                        </div>

                        <!-- Custom API URL field -->
                        <div class="form-group" id="apiUrlGroup" style="display: none;">
                            <label for="apiUrl">
                                API Base URL
                                <span class="tooltip">?
                                    <span class="tooltiptext">Custom API endpoint URL (e.g., http://localhost:11434 for Ollama)</span>
                                </span>
                            </label>
                            <input type="url" id="apiUrl" placeholder="https://api.example.com/v1">
                        </div>

                        <!-- Model selection -->
                        <div class="form-group" id="modelGroup" style="display: none;">
                            <label for="modelName">
                                Model Name
                                <span class="tooltip">?
                                    <span class="tooltiptext">Specific model to use (e.g., llama3.1, mixtral-8x7b-32768)</span>
                                </span>
                            </label>
                            <input type="text" id="modelName" placeholder="Enter model name">
                        </div>

                        <!-- Azure specific fields -->
                        <div class="form-group" id="azureResourceGroup" style="display: none;">
                            <label for="azureResource">Azure Resource Name</label>
                            <input type="text" id="azureResource" placeholder="your-resource-name">
                        </div>
                        <div class="form-group" id="azureDeploymentGroup" style="display: none;">
                            <label for="azureDeployment">Deployment Name</label>
                            <input type="text" id="azureDeployment" placeholder="your-deployment-name">
                        </div>

                        <!-- Custom headers for advanced users -->
                        <div class="form-group" id="customHeadersGroup" style="display: none;">
                            <label for="customHeaders">
                                Custom Headers (JSON)
                                <span class="tooltip">?
                                    <span class="tooltiptext">Additional headers as JSON object: {"Custom-Header": "value"}</span>
                                </span>
                            </label>
                            <textarea id="customHeaders" rows="3" placeholder='{"Authorization": "Bearer token", "Custom-Header": "value"}'></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><span class="section-number">4</span>Template Upload</h3>
                    <div class="form-group">
                        <label>
                            PowerPoint Template (.pptx or .potx)
                            <span class="tooltip">?
                                <span class="tooltiptext">Upload a template to copy its style, colors, fonts, and layout to your generated presentation</span>
                            </span>
                        </label>
                        <div class="file-upload">
                            <input type="file" id="templateFile" class="file-input" accept=".pptx,.potx" required>
                            <label for="templateFile" class="file-label" id="fileLabel">
                                <div>üìÅ Click to upload or drag & drop your template</div>
                                <div style="font-size: 0.9em; color: #718096; margin-top: 5px;">
                                    Supports .pptx and .potx files (max 50MB)
                                </div>
                            </label>
                        </div>
                        <div id="fileInfo" class="file-info" style="display: none;"></div>
                    </div>
                </div>

                <button type="submit" class="generate-btn" id="generateBtn">
                    üöÄ Generate PowerPoint Presentation
                </button>
            </form>

            <div id="progress" class="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText">Processing your presentation...</div>
            </div>

            <div id="error" class="error"></div>
            <div id="success" class="success"></div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>üé® Template Matching</h4>
                <p>Automatically applies colors, fonts, and layouts from your uploaded template</p>
            </div>
            <div class="feature-card">
                <h4>ü§ñ Universal AI Support</h4>
                <p>Works with 10+ LLM providers including OpenAI, Anthropic, local models, and custom APIs</p>
            </div>
            <div class="feature-card">
                <h4>üìù Flexible Input</h4>
                <p>Supports markdown, plain text, and long-form prose content with smart structuring</p>
            </div>
            <div class="feature-card">
                <h4>üîí Privacy First</h4>
                <p>API keys never stored, supports local models, all processing happens client-side when possible</p>
            </div>
            <div class="feature-card">
                <h4>‚ö° Performance Options</h4>
                <p>Choose from ultra-fast inference (Groq) to powerful reasoning (GPT-4) based on your needs</p>
            </div>
            <div class="feature-card">
                <h4>üåê Local & Cloud</h4>
                <p>Deploy with cloud APIs or run completely offline with Ollama and local models</p>
            </div>
        </div>
    </div>

    <script>
        class PowerPointGenerator {
            constructor() {
                this.templateData = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                const form = document.getElementById('pptForm');
                const fileInput = document.getElementById('templateFile');
                const fileLabel = document.getElementById('fileLabel');
                const llmProvider = document.getElementById('llmProvider');

                form.addEventListener('submit', (e) => this.handleSubmit(e));
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                llmProvider.addEventListener('change', (e) => this.handleProviderChange(e));

                // Drag and drop
                fileLabel.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileLabel.classList.add('dragover');
                });

                fileLabel.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileLabel.classList.remove('dragover');
                });

                fileLabel.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileLabel.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        this.handleFileSelect({ target: { files } });
                    }
                });
            }

            handleProviderChange(event) {
                const provider = event.target.value;
                const apiUrlGroup = document.getElementById('apiUrlGroup');
                const modelGroup = document.getElementById('modelGroup');
                const azureResourceGroup = document.getElementById('azureResourceGroup');
                const azureDeploymentGroup = document.getElementById('azureDeploymentGroup');
                const customHeadersGroup = document.getElementById('customHeadersGroup');
                const apiKeyGroup = document.getElementById('apiKeyGroup');
                const apiKey = document.getElementById('apiKey');
                const apiUrl = document.getElementById('apiUrl');
                const modelName = document.getElementById('modelName');

                // Reset all fields
                apiUrlGroup.style.display = 'none';
                modelGroup.style.display = 'none';
                azureResourceGroup.style.display = 'none';
                azureDeploymentGroup.style.display = 'none';
                customHeadersGroup.style.display = 'none';
                apiKey.placeholder = 'Enter your API key';

                // Configure based on provider
                switch (provider) {
                    case 'ollama':
                        apiUrlGroup.style.display = 'block';
                        modelGroup.style.display = 'block';
                        apiUrl.value = 'http://localhost:11434';
                        modelName.placeholder = 'llama3.1, codellama, mistral, etc.';
                        apiKey.placeholder = 'Not required for local Ollama (optional)';
                        apiKey.required = false;
                        break;

                    case 'azure-openai':
                        azureResourceGroup.style.display = 'block';
                        azureDeploymentGroup.style.display = 'block';
                        apiKey.placeholder = 'Azure OpenAI API Key';
                        break;

                    case 'together-ai':
                        modelGroup.style.display = 'block';
                        apiUrl.value = 'https://api.together.xyz';
                        modelName.placeholder = 'meta-llama/Llama-2-70b-chat-hf, mistralai/Mixtral-8x7B-Instruct-v0.1';
                        break;

                    case 'groq':
                        modelGroup.style.display = 'block';
                        apiUrl.value = 'https://api.groq.com/openai/v1';
                        modelName.placeholder = 'mixtral-8x7b-32768, llama2-70b-4096, gemma-7b-it';
                        break;

                    case 'perplexity':
                        modelGroup.style.display = 'block';
                        apiUrl.value = 'https://api.perplexity.ai';
                        modelName.placeholder = 'llama-3.1-sonar-large-128k-online, llama-3.1-sonar-small-128k-chat';
                        break;

                    case 'cohere':
                        apiUrl.value = 'https://api.cohere.ai/v1';
                        modelName.value = 'command-r-plus';
                        break;

                    case 'mistral-ai':
                        modelGroup.style.display = 'block';
                        apiUrl.value = 'https://api.mistral.ai/v1';
                        modelName.placeholder = 'mistral-large, mistral-medium, mistral-small';
                        break;

                    case 'openai-compatible':
                        apiUrlGroup.style.display = 'block';
                        modelGroup.style.display = 'block';
                        customHeadersGroup.style.display = 'block';
                        apiUrl.placeholder = 'https://your-api.com/v1';
                        modelName.placeholder = 'your-model-name';
                        break;

                    case 'custom':
                        apiUrlGroup.style.display = 'block';
                        modelGroup.style.display = 'block';
                        customHeadersGroup.style.display = 'block';
                        apiUrl.placeholder = 'https://your-custom-api.com/endpoint';
                        modelName.placeholder = 'custom-model-name';
                        break;

                    default:
                        // Standard providers
                        apiKey.required = true;
                        if (provider.includes('openai')) {
                            apiKey.placeholder = 'OpenAI API Key (sk-...)';
                        } else if (provider.includes('anthropic')) {
                            apiKey.placeholder = 'Anthropic API Key';
                        } else if (provider.includes('gemini')) {
                            apiKey.placeholder = 'Google AI API Key';
                        }
                }

                // Show model group for providers that need it
                if (provider === 'openai-compatible' || provider === 'custom' || 
                    provider === 'together-ai' || provider === 'groq' || 
                    provider === 'perplexity' || provider === 'mistral-ai' || 
                    provider === 'ollama') {
                    modelGroup.style.display = 'block';
                }

                // Show API URL for custom/self-hosted providers
                if (provider === 'openai-compatible' || provider === 'custom' || 
                    provider === 'ollama' || provider === 'together-ai' || 
                    provider === 'groq' || provider === 'perplexity' || 
                    provider === 'cohere' || provider === 'mistral-ai') {
                    apiUrlGroup.style.display = 'block';
                }
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const fileInfo = document.getElementById('fileInfo');
                const maxSize = 50 * 1024 * 1024; // 50MB

                if (file.size > maxSize) {
                    this.showError('File size must be less than 50MB');
                    return;
                }

                if (!file.name.match(/\.(pptx|potx)$/i)) {
                    this.showError('Please upload a .pptx or .potx file');
                    return;
                }

                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `
                    <strong>Selected:</strong> ${file.name}<br>
                    <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    <strong>Type:</strong> ${file.type || 'PowerPoint Template'}
                `;

                try {
                    // Read and analyze template
                    this.templateData = await this.analyzeTemplate(file);
                    this.showSuccess('Template analyzed successfully! Ready to generate presentation.');
                } catch (error) {
                    this.showError('Error analyzing template: ' + error.message);
                }
            }

            async analyzeTemplate(file) {
                const zip = await JSZip.loadAsync(file);
                const templateData = {
                    slides: [],
                    theme: null,
                    images: {},
                    layouts: []
                };

                // Extract theme colors and fonts
                const themeFile = zip.file('ppt/theme/theme1.xml');
                if (themeFile) {
                    const themeContent = await themeFile.async('text');
                    templateData.theme = this.parseTheme(themeContent);
                }

                // Extract slide layouts
                const slideLayouts = zip.file(/ppt\/slideLayouts\/slideLayout\d+\.xml/);
                for (let layout of slideLayouts) {
                    const content = await layout.async('text');
                    templateData.layouts.push(this.parseLayout(content));
                }

                // Extract existing slides for reference
                const slides = zip.file(/ppt\/slides\/slide\d+\.xml/);
                for (let slide of slides) {
                    const content = await slide.async('text');
                    templateData.slides.push(this.parseSlide(content));
                }

                // Extract images
                const images = zip.file(/ppt\/media\/.+\.(png|jpg|jpeg|gif)$/i);
                for (let img of images) {
                    const blob = await img.async('blob');
                    const url = URL.createObjectURL(blob);
                    templateData.images[img.name] = url;
                }

                return templateData;
            }

            parseTheme(xml) {
                // Extract color scheme and font information
                const parser = new DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                
                const colorScheme = {};
                const clrScheme = doc.querySelector('a\\:clrScheme, clrScheme');
                if (clrScheme) {
                    const colors = clrScheme.querySelectorAll('a\\:sysClr, a\\:srgbClr, sysClr, srgbClr');
                    colors.forEach(color => {
                        const val = color.getAttribute('val') || color.getAttribute('lastClr');
                        if (val) colorScheme[color.parentNode.nodeName] = val;
                    });
                }

                const fontScheme = {};
                const fontSchemeNode = doc.querySelector('a\\:fontScheme, fontScheme');
                if (fontSchemeNode) {
                    const fonts = fontSchemeNode.querySelectorAll('a\\:latin, latin');
                    fonts.forEach(font => {
                        const typeface = font.getAttribute('typeface');
                        if (typeface) {
                            fontScheme[font.parentNode.nodeName] = typeface;
                        }
                    });
                }

                return { colorScheme, fontScheme };
            }

            parseLayout(xml) {
                // Parse slide layout structure
                const parser = new DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                
                const placeholders = [];
                const phElements = doc.querySelectorAll('p\\:ph, ph');
                phElements.forEach(ph => {
                    placeholders.push({
                        type: ph.getAttribute('type') || 'content',
                        idx: ph.getAttribute('idx') || '0'
                    });
                });

                return { placeholders };
            }

            parseSlide(xml) {
                // Parse individual slide content for reference
                const parser = new DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                
                const textContent = [];
                const textElements = doc.querySelectorAll('a\\:t, t');
                textElements.forEach(el => {
                    if (el.textContent.trim()) {
                        textContent.push(el.textContent.trim());
                    }
                });

                return { textContent };
            }

            async handleSubmit(event) {
                event.preventDefault();
                
                const inputText = document.getElementById('inputText').value;
                const guidance = document.getElementById('guidance').value;
                const llmProvider = document.getElementById('llmProvider').value;
                const apiKey = document.getElementById('apiKey').value;

                if (!this.templateData) {
                    this.showError('Please upload a template file first');
                    return;
                }

                this.showProgress();
                this.setProgress(10, 'Analyzing your content...');

                try {
                    // Step 1: Generate slide structure using AI
                    this.setProgress(30, 'Creating slide structure...');
                    const slideStructure = await this.generateSlideStructure(inputText, guidance, llmProvider, apiKey);

                    // Step 2: Create PowerPoint file
                    this.setProgress(60, 'Building PowerPoint presentation...');
                    const pptxBlob = await this.createPowerPoint(slideStructure);

                    // Step 3: Download
                    this.setProgress(100, 'Download ready!');
                    this.downloadFile(pptxBlob, 'generated-presentation.pptx');
                    
                    this.hideProgress();
                    this.showSuccess('Presentation generated successfully! Download should start automatically.');

                } catch (error) {
                    this.hideProgress();
                    this.showError('Error generating presentation: ' + error.message);
                    console.error('Generation error:', error);
                }
            }

            async generateSlideStructure(inputText, guidance, provider, apiKey) {
                const prompt = `
                Analyze the following text and create a structured PowerPoint presentation outline.
                
                Input text: "${inputText}"
                
                ${guidance ? `Additional guidance: "${guidance}"` : ''}
                
                Please return a JSON structure with the following format:
                {
                    "title": "Presentation Title",
                    "slides": [
                        {
                            "type": "title",
                            "title": "Main Title",
                            "subtitle": "Subtitle (optional)"
                        },
                        {
                            "type": "content",
                            "title": "Slide Title",
                            "content": [
                                "Bullet point 1",
                                "Bullet point 2",
                                "Bullet point 3"
                            ]
                        }
                    ]
                }
                
                Guidelines:
                - Create 5-12 slides depending on content length
                - Use slide types: "title", "content", "section"
                - Keep bullet points concise and impactful
                - Include a title slide and conclusion slide
                - Structure content logically with clear sections
                
                Return only valid JSON, no additional text.
                `;

                const response = await this.callLLM(provider, apiKey, prompt);
                
                try {
                    return JSON.parse(response);
                } catch (e) {
                    // Fallback parsing if JSON is wrapped in markdown
                    const jsonMatch = response.match(/```(?:json)?\s*(\{[\s\S]*\})\s*```/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[1]);
                    }
                    throw new Error('Invalid JSON response from AI');
                }
            }

            async callLLM(provider, apiKey, prompt) {
                const apiUrl = document.getElementById('apiUrl')?.value;
                const modelName = document.getElementById('modelName')?.value;
                const customHeaders = document.getElementById('customHeaders')?.value;
                const azureResource = document.getElementById('azureResource')?.value;
                const azureDeployment = document.getElementById('azureDeployment')?.value;

                let requestUrl, headers, body;

                // Parse custom headers if provided
                let additionalHeaders = {};
                if (customHeaders) {
                    try {
                        additionalHeaders = JSON.parse(customHeaders);
                    } catch (e) {
                        console.warn('Invalid custom headers JSON, ignoring:', e);
                    }
                }

                // Configure based on provider type
                switch (provider) {
                    case 'openai-gpt4':
                    case 'openai-gpt4-turbo':
                    case 'openai-gpt35-turbo':
                        const openaiModel = provider === 'openai-gpt4' ? 'gpt-4' :
                                          provider === 'openai-gpt4-turbo' ? 'gpt-4-turbo' : 'gpt-3.5-turbo';
                        requestUrl = 'https://api.openai.com/v1/chat/completions';
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            model: openaiModel,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 2000
                        };
                        break;

                    case 'anthropic-claude35-sonnet':
                    case 'anthropic-claude3-opus':
                    case 'anthropic-claude3-sonnet':
                        const claudeModel = provider === 'anthropic-claude35-sonnet' ? 'claude-3-5-sonnet-20240620' :
                                          provider === 'anthropic-claude3-opus' ? 'claude-3-opus-20240229' : 'claude-3-sonnet-20240229';
                        requestUrl = 'https://api.anthropic.com/v1/messages';
                        headers = {
                            'x-api-key': apiKey,
                            'Content-Type': 'application/json',
                            'anthropic-version': '2023-06-01',
                            ...additionalHeaders
                        };
                        body = {
                            model: claudeModel,
                            max_tokens: 2000,
                            messages: [{ role: 'user', content: prompt }]
                        };
                        break;

                    case 'gemini-15-pro':
                    case 'gemini-15-flash':
                    case 'gemini-10-pro':
                        const geminiModel = provider === 'gemini-15-pro' ? 'gemini-1.5-pro' :
                                          provider === 'gemini-15-flash' ? 'gemini-1.5-flash' : 'gemini-1.0-pro';
                        requestUrl = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;
                        headers = {
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            contents: [{ parts: [{ text: prompt }] }]
                        };
                        break;

                    case 'azure-openai':
                        if (!azureResource || !azureDeployment) {
                            throw new Error('Azure resource name and deployment name are required');
                        }
                        requestUrl = `https://${azureResource}.openai.azure.com/openai/deployments/${azureDeployment}/chat/completions?api-version=2024-02-01`;
                        headers = {
                            'api-key': apiKey,
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 2000
                        };
                        break;

                    case 'ollama':
                        const ollamaUrl = apiUrl || 'http://localhost:11434';
                        const ollamaModel = modelName || 'llama3.1';
                        requestUrl = `${ollamaUrl}/api/generate`;
                        headers = {
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        if (apiKey) {
                            headers['Authorization'] = `Bearer ${apiKey}`;
                        }
                        body = {
                            model: ollamaModel,
                            prompt: prompt,
                            stream: false
                        };
                        break;

                    case 'together-ai':
                        const togetherModel = modelName || 'meta-llama/Llama-2-70b-chat-hf';
                        requestUrl = `${apiUrl || 'https://api.together.xyz'}/v1/chat/completions`;
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            model: togetherModel,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 2000
                        };
                        break;

                    case 'groq':
                        const groqModel = modelName || 'mixtral-8x7b-32768';
                        requestUrl = `${apiUrl || 'https://api.groq.com/openai/v1'}/chat/completions`;
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            model: groqModel,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 2000
                        };
                        break;

                    case 'perplexity':
                        const perplexityModel = modelName || 'llama-3.1-sonar-large-128k-online';
                        requestUrl = `${apiUrl || 'https://api.perplexity.ai'}/chat/completions`;
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            model: perplexityModel,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 2000
                        };
                        break;

                    case 'cohere':
                        requestUrl = `${apiUrl || 'https://api.cohere.ai/v1'}/chat`;
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            model: modelName || 'command-r-plus',
                            message: prompt,
                            max_tokens: 2000
                        };
                        break;

                    case 'mistral-ai':
                        const mistralModel = modelName || 'mistral-large-latest';
                        requestUrl = `${apiUrl || 'https://api.mistral.ai/v1'}/chat/completions`;
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            model: mistralModel,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 2000
                        };
                        break;

                    case 'openai-compatible':
                    case 'custom':
                        if (!apiUrl) {
                            throw new Error('API URL is required for custom providers');
                        }
                        requestUrl = `${apiUrl}/chat/completions`;
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            ...additionalHeaders
                        };
                        body = {
                            model: modelName || 'default',
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 2000
                        };
                        break;

                    default:
                        throw new Error('Unsupported LLM provider');
                }

                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed: ${response.status} ${response.statusText}\n${errorText}`);
                }

                const data = await response.json();

                // Parse response based on provider
                switch (provider) {
                    case 'openai-gpt4':
                    case 'openai-gpt4-turbo':
                    case 'openai-gpt35-turbo':
                    case 'together-ai':
                    case 'groq':
                    case 'perplexity':
                    case 'mistral-ai':
                    case 'openai-compatible':
                    case 'custom':
                        return data.choices[0].message.content;
                    
                    case 'anthropic-claude35-sonnet':
                    case 'anthropic-claude3-opus':
                    case 'anthropic-claude3-sonnet':
                        return data.content[0].text;
                    
                    case 'gemini-15-pro':
                    case 'gemini-15-flash':
                    case 'gemini-10-pro':
                        return data.candidates[0].content.parts[0].text;
                    
                    case 'azure-openai':
                        return data.choices[0].message.content;
                    
                    case 'ollama':
                        return data.response;
                    
                    case 'cohere':
                        return data.text;
                    
                    default:
                        throw new Error('Unknown provider response format');
                }
            }

            async createPowerPoint(slideStructure) {
                // Create a new PowerPoint structure using the template
                const zip = new JSZip();
                
                // Basic PowerPoint structure
                const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
                        <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
                        <Default Extension="xml" ContentType="application/xml"/>
                        <Override PartName="/ppt/presentation.xml" ContentType="application/vnd.openxmlformats-presentationml.presentation.main+xml"/>
                        <Override PartName="/ppt/slides/slide1.xml" ContentType="application/vnd.openxmlformats-presentationml.slide+xml"/>
                    </Types>`;

                const appProps = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties" xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
                        <Application>Text to PowerPoint Generator</Application>
                        <ScaleCrop>false</ScaleCrop>
                        <DocSecurity>0</DocSecurity>
                    </Properties>`;

                const coreProps = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                        <dc:title>${slideStructure.title || 'Generated Presentation'}</dc:title>
                        <dc:creator>Text to PowerPoint Generator</dc:creator>
                        <dcterms:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:created>
                        <dcterms:modified xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:modified>
                    </cp:coreProperties>`;

                // Add basic structure files
                zip.file('[Content_Types].xml', contentTypes);
                zip.file('docProps/app.xml', appProps);
                zip.file('docProps/core.xml', coreProps);

                // Create slides
                const slides = slideStructure.slides.map((slide, index) => {
                    return this.createSlideXML(slide, index + 1);
                });

                // Add slides to zip
                slides.forEach((slideXML, index) => {
                    zip.file(`ppt/slides/slide${index + 1}.xml`, slideXML);
                });

                // Create presentation.xml
                const presentationXML = this.createPresentationXML(slides.length);
                zip.file('ppt/presentation.xml', presentationXML);

                // Add relationships
                const mainRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
                        <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="ppt/presentation.xml"/>
                        <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
                        <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
                    </Relationships>`;

                zip.file('_rels/.rels', mainRels);

                return await zip.generateAsync({ type: 'blob' });
            }

            createSlideXML(slide, slideNumber) {
                const colors = this.templateData?.theme?.colorScheme || {};
                const fonts = this.templateData?.theme?.fontScheme || {};

                let slideContent = '';
                
                if (slide.type === 'title') {
                    slideContent = `
                        <p:sp>
                            <p:nvSpPr><p:cNvPr id="1" name="Title"/><p:cNvSpPr><a:spLocks noGrp="1"/></p:cNvSpPr><p:nvPr><p:ph type="ctrTitle"/></p:nvPr></p:nvSpPr>
                            <p:spPr/>
                            <p:txBody>
                                <a:bodyPr/>
                                <a:lstStyle/>
                                <a:p><a:r><a:rPr lang="en-US" sz="4400" b="1"><a:solidFill><a:schemeClr val="tx1"/></a:solidFill><a:latin typeface="${fonts.majorFont || 'Calibri'}"/></a:rPr><a:t>${this.escapeXML(slide.title)}</a:t></a:r></a:p>
                            </p:txBody>
                        </p:sp>`;
                    
                    if (slide.subtitle) {
                        slideContent += `
                        <p:sp>
                            <p:nvSpPr><p:cNvPr id="2" name="Subtitle"/><p:cNvSpPr><a:spLocks noGrp="1"/></p:cNvSpPr><p:nvPr><p:ph type="subTitle"/></p:nvPr></p:nvSpPr>
                            <p:spPr/>
                            <p:txBody>
                                <a:bodyPr/>
                                <a:lstStyle/>
                                <a:p><a:r><a:rPr lang="en-US" sz="2400"><a:solidFill><a:schemeClr val="tx1"/></a:solidFill><a:latin typeface="${fonts.minorFont || 'Calibri'}"/></a:rPr><a:t>${this.escapeXML(slide.subtitle)}</a:t></a:r></a:p>
                            </p:txBody>
                        </p:sp>`;
                    }
                } else if (slide.type === 'content' || slide.type === 'section') {
                    slideContent = `
                        <p:sp>
                            <p:nvSpPr><p:cNvPr id="1" name="Title"/><p:cNvSpPr><a:spLocks noGrp="1"/></p:cNvSpPr><p:nvPr><p:ph type="title"/></p:nvPr></p:nvSpPr>
                            <p:spPr/>
                            <p:txBody>
                                <a:bodyPr/>
                                <a:lstStyle/>
                                <a:p><a:r><a:rPr lang="en-US" sz="2800" b="1"><a:solidFill><a:schemeClr val="tx1"/></a:solidFill><a:latin typeface="${fonts.majorFont || 'Calibri'}"/></a:rPr><a:t>${this.escapeXML(slide.title)}</a:t></a:r></a:p>
                            </p:txBody>
                        </p:sp>`;

                    if (slide.content && slide.content.length > 0) {
                        const bulletPoints = slide.content.map(point => 
                            `<a:p><a:pPr lvl="0"><a:buChar char="‚Ä¢"/></a:pPr><a:r><a:rPr lang="en-US" sz="2000"><a:solidFill><a:schemeClr val="tx1"/></a:solidFill><a:latin typeface="${fonts.minorFont || 'Calibri'}"/></a:rPr><a:t>${this.escapeXML(point)}</a:t></a:r></a:p>`
                        ).join('');

                        slideContent += `
                        <p:sp>
                            <p:nvSpPr><p:cNvPr id="2" name="Content"/><p:cNvSpPr><a:spLocks noGrp="1"/></p:cNvSpPr><p:nvPr><p:ph type="body"/></p:nvPr></p:nvSpPr>
                            <p:spPr/>
                            <p:txBody>
                                <a:bodyPr/>
                                <a:lstStyle/>
                                ${bulletPoints}
                            </p:txBody>
                        </p:sp>`;
                    }
                }

                return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <p:sld xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:p="http://schemas.openxmlformats.org/presentationml/2006/main">
                        <p:cSld>
                            <p:spTree>
                                <p:nvGrpSpPr><p:cNvPr id="1" name=""/><p:cNvGrpSpPr/><p:nvPr/></p:nvGrpSpPr>
                                <p:grpSpPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="0" cy="0"/><a:chOff x="0" y="0"/><a:chExt cx="0" cy="0"/></a:xfrm></p:grpSpPr>
                                ${slideContent}
                            </p:spTree>
                        </p:cSld>
                        <p:clrMapOvr><a:masterClrMapping/></p:clrMapOvr>
                    </p:sld>`;
            }

            createPresentationXML(slideCount) {
                const slideIds = Array.from({ length: slideCount }, (_, i) => 
                    `<p:sldId id="${256 + i}" r:id="rId${i + 1}"/>`
                ).join('');

                const relationships = Array.from({ length: slideCount }, (_, i) =>
                    `<Relationship Id="rId${i + 1}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide" Target="slides/slide${i + 1}.xml"/>`
                ).join('');

                // Create presentation relationships file
                const presRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
                        ${relationships}
                    </Relationships>`;

                // Add to zip in the calling method
                setTimeout(() => {
                    const zip = new JSZip();
                    zip.file('ppt/_rels/presentation.xml.rels', presRels);
                }, 0);

                return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <p:presentation xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:p="http://schemas.openxmlformats.org/presentationml/2006/main" saveSubsetFonts="1">
                        <p:sldMasterIdLst><p:sldMasterId id="2147483648" r:id="rId1"/></p:sldMasterIdLst>
                        <p:sldIdLst>
                            ${slideIds}
                        </p:sldIdLst>
                        <p:sldSz cx="9144000" cy="6858000"/>
                        <p:notesSz cx="6858000" cy="9144000"/>
                    </p:presentation>`;
            }

            escapeXML(text) {
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            downloadFile(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showProgress() {
                document.getElementById('progress').style.display = 'block';
                document.getElementById('generateBtn').disabled = true;
            }

            hideProgress() {
                document.getElementById('progress').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
            }

            setProgress(percent, text) {
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('progressText').textContent = text;
            }

            showError(message) {
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                document.getElementById('success').style.display = 'none';
            }

            showSuccess(message) {
                const successDiv = document.getElementById('success');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                document.getElementById('error').style.display = 'none';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new PowerPointGenerator();
        });
    </script>
</body>
</html>
